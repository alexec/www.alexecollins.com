<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1.0"> <meta name=google-site-verification content=459WLyNfyiKwT7T3IzdCjzIpNP-IVQSOb4tR8b2vQhI /> <title>Alex Collins - Tutorial: JUnit @Rule</title> <link href="/css/bootstrap.min.css" media=screen rel=stylesheet /> <style type="text/css">
.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight {
  color: #faf6e4;
  background-color: #122b3b;
}
.highlight .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #6c8b9f;
  font-style: italic;
}
.highlight .cp {
  color: #b2fd6d;
  font-weight: bold;
  font-style: italic;
}
.highlight .err {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .gr {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .k, .highlight .kd, .highlight .kv {
  color: #f6dd62;
  font-weight: bold;
}
.highlight .o, .highlight .ow {
  color: #4df4ff;
}
.highlight .p, .highlight .pi {
  color: #4df4ff;
}
.highlight .gd {
  color: #cc0000;
}
.highlight .gi {
  color: #b2fd6d;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .kc {
  color: #f696db;
  font-weight: bold;
}
.highlight .kn {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kp {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kr {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gh {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gu {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kt {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .no {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nc {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nd {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nn {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .bp {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .ne {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nl {
  color: #ffb000;
  font-weight: bold;
}
.highlight .nt {
  color: #ffb000;
  font-weight: bold;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #f696db;
  font-weight: bold;
}
.highlight .ld {
  color: #f696db;
  font-weight: bold;
}
.highlight .ss {
  color: #f696db;
  font-weight: bold;
}
.highlight .s, .highlight .sb, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .sr, .highlight .s1 {
  color: #fff0a6;
  font-weight: bold;
}
.highlight .se {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .sc {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .si {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .nb {
  font-weight: bold;
}
.highlight .ni {
  color: #999999;
  font-weight: bold;
}
.highlight .w {
  color: #BBBBBB;
}
.highlight .nf {
  color: #a8e1fe;
}
.highlight .py {
  color: #a8e1fe;
}
.highlight .na {
  color: #a8e1fe;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi {
  color: #a8e1fe;
  font-weight: bold;
}	.article img {
		border: 1px solid #bbb;
		display: block;
		margin-left: auto;
		margin-right: auto;
		padding: 10px;
	}
	@media print {
		#disqus_thread, #sidebar {
    			display:none;
  		}
	}
</style> <link href="https://plus.google.com/101694420547181110548" rel=publisher /> </head> <body class="tutorial-junit-rule tutorial-junit-rule_index"> <div class=container> <div class=row> <div class="col-md-9 article"> <h1>Tutorial: JUnit @Rule</h1> <table class=table> <tr> <td> <center> <a href="//selenium-webdriver-in-practice.github.io"><img src="/images/liang_cover100.jpg" class=thumbnail /></a> </center> </td> <td> <p class=well><b>Big news!</b> I've been working hard getting <b>Selenium WebDriver in Practice</b> ready and it is now available to buy on the <a href="//selenium-webdriver-in-practice.github.io">Manning Early Access Program</a>. It provides practical and useful techniques you can use with WebDriver, to get the very best out of it in your projects.</p> </td> </tr> </table> <h2>Overview</h2> <p>Recent versions of JUnit have added support for a concept called rules, a system similar to custom runners, but without some of the restrictions. This tutorial looks at creating custom rules, how this can simplify integration with Spring and Mockito, and how you can create simpler and more powerful tests using them.</p> <h2>Rules as Runners</h2> <p>You might be familiar with SpringJUnit4ClassRunner or MockitoJUnitRunner, both of which can be applied to a test class to inject dependencies - either from the application context into fields annotated with @Autowired the case of Spring, or mocks annotated with the @Mock annotation in the case of Mockito, for example:</p> <pre class="highlight java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="s">"classpath:testContext.xml"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="o">{</span>
	
<span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">foo</span><span class="o">;</span>
<span class="o">...</span>
</pre> <p>Or</p> <pre class="highlight java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">MockitoJUnitRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BarTest</span> <span class="o">{</span>
	
	<span class="nd">@Mock</span>
	<span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">bar</span><span class="o">;</span>
</pre> <p>What if you wanted both mocks and dependencies and injected? In recent JUnit versions (&gt;= 4.7), @RunsWith can be replaced with @Rule. @Rule can be used by a class in indicate that it requires work done before and after a test's execution. This can allow you to test standard parts of your application, while at the same time, creating the context that you need to run you tests in. For example, you could verify some test invariants, create an application context or set-up a JPA session/JDBC connection for integration tests.</p> <p>Lets start with a basic set of boiler-plate dependencies in our pom.xml:</p> <pre class="highlight xml"><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.5.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-test<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.5.6<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.mockito<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>mockito-core<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>1.9.0<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>4.10<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre> <p>Next we'll create a rule for injecting @Autowired dependencies. This rule wraps each execution of a test within the class by creating a context, injecting the beans into the classes fields, and managing the life-cyle of that context.</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringContextRule</span> <span class="kd">implements</span> <span class="n">TestRule</span> <span class="o">{</span>
	
    <span class="cm">/** A list of class-path contexts. */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">locations</span><span class="o">;</span>
    
    <span class="cm">/** The target test. */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">target</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">SpringContextRule</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">locations</span><span class="o">,</span> <span class="n">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">locations</span> <span class="o">=</span> <span class="n">locations</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Statement</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Statement</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="n">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span>
                        <span class="n">locations</span><span class="o">);</span>
                <span class="n">context</span><span class="o">.</span><span class="na">getAutowireCapableBeanFactory</span><span class="o">().</span><span class="na">autowireBean</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
                <span class="n">context</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">base</span><span class="o">.</span><span class="na">evaluate</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">context</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>We can test this works using a small context and test, that verifies that auto-wired fields are set as expected.</p> <pre class="highlight xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd"</span><span class="nt">&gt;</span>

	<span class="nt">&lt;context:annotation-config/&gt;</span>

	<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"bar"</span> <span class="na">class=</span><span class="s">"java.lang.String"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">"bar"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="o">{</span>

	<span class="nd">@Rule</span>
	<span class="kd">public</span> <span class="n">TestRule</span> <span class="n">contextRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringContextRule</span><span class="o">(</span>
			<span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">"testContext.xml"</span> <span class="o">},</span> <span class="k">this</span><span class="o">);</span>

	<span class="nd">@Autowired</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="n">bar</span><span class="o">;</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="n">testBaz</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">assertEquals</span><span class="o">(</span><span class="s">"bar"</span><span class="o">,</span> <span class="n">bar</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre> <p>Next we can extend this, by adding a mocking rule. This will simply populate the mocks before each test.</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockRule</span> <span class="kd">implements</span> <span class="n">TestRule</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">target</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">MockRule</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Statement</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Statement</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="n">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">MockitoAnnotations</span><span class="o">.</span><span class="na">initMocks</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
                <span class="n">base</span><span class="o">.</span><span class="na">evaluate</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>Finally, lets put it all together with a final test.</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooTest</span> <span class="o">{</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">TestRule</span> <span class="n">contextRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringContextRule</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="s">"testContext.xml"</span><span class="o">},</span> <span class="k">this</span><span class="o">);</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">TestRule</span> <span class="n">mockRule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MockRule</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">bar</span><span class="o">;</span>

    <span class="nd">@Mock</span>
    <span class="kd">public</span> <span class="n">List</span> <span class="n">baz</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testBar</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="s">"bar"</span><span class="o">,</span> <span class="n">bar</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testBaz</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">when</span><span class="o">(</span><span class="n">baz</span><span class="o">.</span><span class="na">size</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">baz</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>This test shows that you can mix two rules together, something that you cannot do with @RunWith. You could create you own custom runner, but that runner would have very poor <a href="//en.wikipedia.org/wiki/Cohesion_(computer_science)">cohesion</a>.</p> <h2>Rules as Invariants</h2> <p>With @Rule, not only can you mix different rules, you can also enforce invariants. To do this, we'll create an marker annotation for fields that should not change, and a new rule to check the invariants.</p> <pre class="highlight java"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Invariant</span> <span class="o">{</span>
<span class="o">}</span>
</pre> <p>The rule cheaply stores each field's hash-codes and then compares them before and after the test, throwing an error if the hash-code has changed.</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InvariantRule</span> <span class="kd">implements</span> <span class="n">TestRule</span> <span class="o">{</span>
	
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">target</span><span class="o">;</span>

    <span class="cm">/**
     * It should be noted that, while cheap and safe, an object can 
     * change, but the hash code not. Bugs that result might be a tricky to diagnose.
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Field</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">fieldToHashCode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Field</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>

    <span class="kd">public</span> <span class="n">InvariantRule</span><span class="o">(</span><span class="n">Object</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Statement</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Statement</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="n">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="n">fieldToHashCode</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Field</span> <span class="n">f</span> <span class="o">:</span> <span class="n">target</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getFields</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">Invariant</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">fieldToHashCode</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">target</span><span class="o">).</span><span class="na">hashCode</span><span class="o">());</span>
                    <span class="o">}</span>
                <span class="o">}</span>

                <span class="n">base</span><span class="o">.</span><span class="na">evaluate</span><span class="o">();</span>

                <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Field</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">fieldToHashCode</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">target</span><span class="o">).</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">!=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionFailedError</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" changed"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>Finally, a test.</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BazTest</span> <span class="o">{</span>

    <span class="nd">@Rule</span>
    <span class="kd">public</span> <span class="n">TestRule</span> <span class="n">invariantRule</span> <span class="o">=</span> <span class="n">RuleChain</span><span class="o">.</span><span class="na">outerRule</span><span class="o">(</span>
            <span class="k">new</span> <span class="n">TestRule</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="n">Statement</span> <span class="n">apply</span><span class="o">(</span><span class="kd">final</span> <span class="n">Statement</span> <span class="n">base</span><span class="o">,</span> <span class="n">Description</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="n">Statement</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="n">evaluate</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                            <span class="n">qux</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
                            <span class="n">base</span><span class="o">.</span><span class="na">evaluate</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">};</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">around</span><span class="o">(</span><span class="k">new</span> <span class="n">InvariantRule</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>

    <span class="nd">@Invariant</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">qux</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testListUnchanged</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// nop</span>
    <span class="o">}</span>

    <span class="nd">@Test</span> <span class="c1">// this will cause on exception</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testListChangedImpliesError</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">qux</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <h2>Conclusion</h2> <p>You may have noted that @Before and @After have not featured in these tests. Rules are executed around @Before/@After and therefore it's not possible to set-up invariants in @Before. Instead we use a rule chain to create what is effectively a @Before using an anonymous inner class. @Rule provides a more powerful and flexible way of reducing boilerplate code in your test.</p> <p>This <a href="https://github.com/alexec/test-support">code is on Github</a>.</p> <div id=disqus_thread></div> <script>
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alexecollins'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> <div class=col-md-3 id=sidebar> <center> <h2>Alex Collins</h2> <p> <a href="/"><img src="/images/alex-collins-circle.png"/></a> </p> </center> <p> Java technical lead and solutions architect in London for the UK IT industry for over ten years. <a href="/about-me">more...</a> </p> <h4>Docker Maven Plugin</h4> <p>Version 2.11.4 released, <a href="https://github.com/alexec/docker-maven-plugin/blob/master/CHANGELOG.md">more...</a></p> <pre style="font-size:50%">&lt;dependency&gt;
  &lt;groupId&gt;com.alexecollins.docker&lt;/groupId&gt;
  &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.11.4&lt;/version&gt;
&lt;/dependency&gt;</pre> <h4>Related</h4> <ol> <li><a href="/tomcat-context-junit-rule/">Tomcat Context JUnit @Rule</a></li> <li><a href="/mocking-test-dependencies-with-spring/">Mocking Test Dependencies with Spring</a></li> <li><a href="/try-fail-catch-assert-junit-patttern/">Try-Fail-Catch-Assert JUnit Patttern</a></li> <li><a href="/tutorial-integration-testing-selenium-part-1/">Tutorial: Integration Testing with Selenium - Part 1</a></li> <li><a href="/tutorial-integration-testing-selenium-part-2/">Tutorial: Integration Testing with Selenium - Part 2</a></li> </ol> <h4>Recent</h4> <ul> <li><a href="/developing-with-docker-proxy-container-pattern/">Developing With Docker - Using The Proxy Container Pattern To Make Development Easier</a> <span>Nov 28</span></li> <li><a href="/practical-domain-specific-language-tutorial/">Practical Java Domain Specific Language Tutorial</a> <span>Sep 19</span></li> <li><a href="/sonarqube-and-java-8/">Sonarqube And Java 8</a> <span>Sep 17</span></li> <li><a href="/spring-boot-performance/">Spring Boot Performance</a> <span>Sep 5</span></li> <li><a href="/testing-anti-patterns/">Testing Anti-Patterns</a> <span>Jun 23</span></li> </ul> <h4>Tags</h4> <a href="/tags/ci/">ci</a> (3)</a>&nbsp;&nbsp; <a href="/tags/concurrency/">concurrency</a> (4)</a>&nbsp;&nbsp; <a href="/tags/docker/">docker</a> (11)</a>&nbsp;&nbsp; <a href="/tags/gist/">gist</a> (13)</a>&nbsp;&nbsp; <a href="/tags/groovy/">groovy</a> (4)</a>&nbsp;&nbsp; <a href="/tags/java/">java</a> (48)</a>&nbsp;&nbsp; <a href="/tags/jmeter/">jmeter</a> (3)</a>&nbsp;&nbsp; <a href="/tags/junit/">junit</a> (7)</a>&nbsp;&nbsp; <a href="/tags/links/">links</a> (14)</a>&nbsp;&nbsp; <a href="/tags/maven/">maven</a> (18)</a>&nbsp;&nbsp; <a href="/tags/oped/">oped</a> (8)</a>&nbsp;&nbsp; <a href="/tags/performance/">performance</a> (6)</a>&nbsp;&nbsp; <a href="/tags/plaf/">plaf</a> (14)</a>&nbsp;&nbsp; <a href="/tags/ruby/">ruby</a> (3)</a>&nbsp;&nbsp; <a href="/tags/selenium/">selenium</a> (9)</a>&nbsp;&nbsp; <a href="/tags/software/">software</a> (10)</a>&nbsp;&nbsp; <a href="/tags/spring/">spring</a> (7)</a>&nbsp;&nbsp; <a href="/tags/swing/">swing</a> (15)</a>&nbsp;&nbsp; <a href="/tags/testing/">testing</a> (23)</a>&nbsp;&nbsp; <a href="/tags/tips/">tips</a> (4)</a>&nbsp;&nbsp; <a href="/tags/tomcat/">tomcat</a> (3)</a>&nbsp;&nbsp; <a href="/tags/unix/">unix</a> (6)</a>&nbsp;&nbsp; <a href="/tags/web/">web</a> (4)</a>&nbsp;&nbsp; </hr/> <p> <a class="btn btn-primary btn-xs" href="/sitemap">Sitemap</a> <a class="btn btn-primary btn-xs" href="/feed.xml">RSS</a> <a class="btn btn-primary btn-xs" href="//uk.linkedin.com/in/alexecollins">LinkedIn</a> </p> </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25388993-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script> </body> </html>