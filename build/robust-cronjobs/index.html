<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1.0"> <meta name=google-site-verification content=459WLyNfyiKwT7T3IzdCjzIpNP-IVQSOb4tR8b2vQhI /> <title>Alex Collins - Robust Cronjobs</title> <link href="/css/bootstrap.min.css" media=screen rel=stylesheet /> <style type="text/css">
.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight {
  color: #faf6e4;
  background-color: #122b3b;
}
.highlight .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #6c8b9f;
  font-style: italic;
}
.highlight .cp {
  color: #b2fd6d;
  font-weight: bold;
  font-style: italic;
}
.highlight .err {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .gr {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .k, .highlight .kd, .highlight .kv {
  color: #f6dd62;
  font-weight: bold;
}
.highlight .o, .highlight .ow {
  color: #4df4ff;
}
.highlight .p, .highlight .pi {
  color: #4df4ff;
}
.highlight .gd {
  color: #cc0000;
}
.highlight .gi {
  color: #b2fd6d;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .kc {
  color: #f696db;
  font-weight: bold;
}
.highlight .kn {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kp {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kr {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gh {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gu {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kt {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .no {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nc {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nd {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nn {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .bp {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .ne {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nl {
  color: #ffb000;
  font-weight: bold;
}
.highlight .nt {
  color: #ffb000;
  font-weight: bold;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #f696db;
  font-weight: bold;
}
.highlight .ld {
  color: #f696db;
  font-weight: bold;
}
.highlight .ss {
  color: #f696db;
  font-weight: bold;
}
.highlight .s, .highlight .sb, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .sr, .highlight .s1 {
  color: #fff0a6;
  font-weight: bold;
}
.highlight .se {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .sc {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .si {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .nb {
  font-weight: bold;
}
.highlight .ni {
  color: #999999;
  font-weight: bold;
}
.highlight .w {
  color: #BBBBBB;
}
.highlight .nf {
  color: #a8e1fe;
}
.highlight .py {
  color: #a8e1fe;
}
.highlight .na {
  color: #a8e1fe;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi {
  color: #a8e1fe;
  font-weight: bold;
}	.article img {
		border: 1px solid #bbb;
		display: block;
		margin-left: auto;
		margin-right: auto;
		padding: 10px;
	}
	@media print {
		#disqus_thread, #sidebar {
    			display:none;
  		}
	}
</style> <link href="https://plus.google.com/101694420547181110548" rel=publisher /> </head> <body class="robust-cronjobs robust-cronjobs_index"> <div class=container> <div class=row> <div class="col-md-9 article"> <h1>Robust Cronjobs</h1> <table class=table> <tr> <td> <center> <a href="//selenium-webdriver-in-practice.github.io"><img src="/images/liang_cover100.jpg" class=thumbnail /></a> </center> </td> <td> <p class=well><b>Big news!</b> I've been working hard getting <b>Selenium WebDriver in Practice</b> ready and it is now available to buy on the <a href="//selenium-webdriver-in-practice.github.io">Manning Early Access Program</a>. It provides practical and useful techniques you can use with WebDriver, to get the very best out of it in your projects.</p> </td> </tr> </table> <p>Cron jobs were the bane of my life. They were fragile, unreliable, time consuming to test, hard to fix. If some failed then they were impossible to re-run. No performance metrics were collected and no monitoring was undertaken. Ultimately they were costly to write, and as no one knew what they did, costly to maintain.</p> <p>Here's some quick tips on writing robust cron jobs.</p> <ol> <li>Considering break your app into two parts: one that does the actual work, and a wrapper script one that sets up the environment, adds logging and error handling.</li> <li>Use the same bash script wrapper and (if possible) configuration on every environment. Otherwise you're not testing the wrapper and you cannot tell if it will worked until you run it in production.</li> <li>Write the app so that it can take parameters for the time frame it should have run for. This will make it easy to test: you can then test it to see how it would have behaved at various times.</li> <li>Make it idempotent so you can repeat each test easily, and if it fails, it can safely be re-run.</li> <li>Consider sourcing ~/.bashrc in your shell wrapper so that your app runs in a similar env in a shell to that when it'll be run by the daemon.</li> <li>If you develop on one machine (e.g. Linux), and deploy to another (e.g. UNIX), then make sure you take this into account. Try and develop scripts that will run in any environment.</li> <li>You can test it using "cd &amp;&amp; env - myapp" so that it is run in the same working directory and a <i>similar</i> env as when it runs as a cron.</li> <li>Log output to a log file (e.g. /var/log/$USER/myapp.out), but remember some errors (e.g. stack traces from you apps main thread) are written to stout or stderr. Handily they will be delivered to the user's UNIX mailbox. You set-up ~/.forward so you can also get a copy in your in-box. Make sure the error is helpful, add the hostname and command for example. Don't forget to rotate, compress and archive your logs.</li> <li>Consider recording reporting metrics from the app. How long it took to run, how many records it processed. These are useful for debugging, and also useful for monitoring performance over longer periods of time, or creating alarms.</li> <li>Document, but not in some obscure, hard to find and un-maintanable article in your corporate intranet. Perhaps document in a README.txt AND the app's help, which could be accessible using a "-h" option.</li> </ol> <p>Here's an simple example:</p> <pre class="highlight shell"><span class="c">#! /bin/sh</span>
<span class="nb">set</span> -eu

<span class="k">function </span>usage <span class="o">{</span>
	<span class="nb">echo</span> &gt;&amp;2 <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> [-n ndayago]"</span>
<span class="o">}</span>

<span class="k">while </span><span class="nb">getopts </span>n: o ; <span class="k">do
	case</span> <span class="s2">"</span><span class="nv">$o</span><span class="s2">"</span> <span class="k">in
	</span>n<span class="p">)</span>	<span class="nv">NDAYSAGO</span><span class="o">=</span><span class="s2">"</span><span class="nv">$OPTARG</span><span class="s2">"</span><span class="p">;;</span>
	<span class="o">[</span>?]<span class="p">)</span>	usage
		<span class="nb">exit </span>1;;
	<span class="k">esac
done
</span><span class="nb">shift</span> <span class="k">$((</span><span class="nv">$OPTIND</span><span class="o">-</span><span class="m">1</span><span class="k">))</span>

<span class="c"># there's no default for -n, so exit if not set</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">"</span><span class="k">${</span><span class="nv">NDAYSAGO</span><span class="k">:-}</span><span class="s2">"</span> <span class="o">]</span> ; <span class="k">then </span>usage ; <span class="nb">exit </span>1 ; <span class="k">fi

</span>find <span class="nv">$TMPDIR</span> -type f -mtime <span class="nv">$NDAYSAGO</span>
</pre> <p>To test this, you can try:</p> <pre class="highlight plaintext">% cd &amp;&amp; env - USER=alexec TMPDIR=$TMPDIR /Users/$USER/bin/find-changed-in-tmp.sh -n 1 &gt; /var/log/$USER/find-changed-in-tmp.$(date +%Y-%m-%d).out
</pre> <p>Note that I need to add the USER and TMPDIR as "env -" will erase them. The resulting crontab entry is:</p> <pre class="highlight plaintext">38 3 * * * /Users/$USER/bin/find-changed-in-tmp.sh -n 1 &gt;&gt; /var/log/$USER/find-changed-in-tmp.$(date +\\%Y-\\%m-\\%d).out 
</pre> <p>Note that I have to escape the percentage symbols, and that I append to the log file so re-runs won't erase the old logs.</p> <p>If you enjoyed this post, you might be interested in <a href="/tips-robust-bash-scripts">this one on robust scripts</a>.</p> <div id=disqus_thread></div> <script>
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alexecollins'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> <div class=col-md-3 id=sidebar> <center> <h2>Alex Collins</h2> <p> <a href="/"><img src="/images/alex-collins-circle.png"/></a> </p> </center> <p> Java technical lead and solutions architect in London for the UK IT industry for over ten years. <a href="/about-me">more...</a> </p> <h4>Docker Maven Plugin</h4> <p>Version 2.11.4 released, <a href="https://github.com/alexec/docker-maven-plugin/blob/master/CHANGELOG.md">more...</a></p> <pre style="font-size:50%">&lt;dependency&gt;
  &lt;groupId&gt;com.alexecollins.docker&lt;/groupId&gt;
  &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.11.4&lt;/version&gt;
&lt;/dependency&gt;</pre> <h4>Related</h4> <ol> <li><a href="/tips-robust-bash-scripts/">Tips For Robust Bash Scripts</a></li> <li><a href="/catalina-restart-sh/">catalina-restart.sh</a></li> <li><a href="/snippet-grep-jar-sh/">Snippet: grep-jar.sh</a></li> <li><a href="/snippet-which-jar-sh/">Snippet: which-jar.sh</a></li> <li><a href="/windows-nix-users/">Windows for *NIX Users</a></li> </ol> <h4>Recent</h4> <ul> <li><a href="/developing-with-docker-proxy-container-pattern/">Developing With Docker - Using The Proxy Container Pattern To Make Development Easier</a> <span>Nov 28</span></li> <li><a href="/practical-domain-specific-language-tutorial/">Practical Java Domain Specific Language Tutorial</a> <span>Sep 19</span></li> <li><a href="/sonarqube-and-java-8/">Sonarqube And Java 8</a> <span>Sep 17</span></li> <li><a href="/spring-boot-performance/">Spring Boot Performance</a> <span>Sep 5</span></li> <li><a href="/testing-anti-patterns/">Testing Anti-Patterns</a> <span>Jun 23</span></li> </ul> <h4>Tags</h4> <a href="/tags/ci/">ci</a> (3)</a>&nbsp;&nbsp; <a href="/tags/concurrency/">concurrency</a> (4)</a>&nbsp;&nbsp; <a href="/tags/docker/">docker</a> (11)</a>&nbsp;&nbsp; <a href="/tags/gist/">gist</a> (13)</a>&nbsp;&nbsp; <a href="/tags/groovy/">groovy</a> (4)</a>&nbsp;&nbsp; <a href="/tags/java/">java</a> (48)</a>&nbsp;&nbsp; <a href="/tags/jmeter/">jmeter</a> (3)</a>&nbsp;&nbsp; <a href="/tags/junit/">junit</a> (7)</a>&nbsp;&nbsp; <a href="/tags/links/">links</a> (14)</a>&nbsp;&nbsp; <a href="/tags/maven/">maven</a> (18)</a>&nbsp;&nbsp; <a href="/tags/oped/">oped</a> (8)</a>&nbsp;&nbsp; <a href="/tags/performance/">performance</a> (6)</a>&nbsp;&nbsp; <a href="/tags/plaf/">plaf</a> (14)</a>&nbsp;&nbsp; <a href="/tags/ruby/">ruby</a> (3)</a>&nbsp;&nbsp; <a href="/tags/selenium/">selenium</a> (9)</a>&nbsp;&nbsp; <a href="/tags/software/">software</a> (10)</a>&nbsp;&nbsp; <a href="/tags/spring/">spring</a> (7)</a>&nbsp;&nbsp; <a href="/tags/swing/">swing</a> (15)</a>&nbsp;&nbsp; <a href="/tags/testing/">testing</a> (23)</a>&nbsp;&nbsp; <a href="/tags/tips/">tips</a> (4)</a>&nbsp;&nbsp; <a href="/tags/tomcat/">tomcat</a> (3)</a>&nbsp;&nbsp; <a href="/tags/unix/">unix</a> (6)</a>&nbsp;&nbsp; <a href="/tags/web/">web</a> (4)</a>&nbsp;&nbsp; </hr/> <p> <a class="btn btn-primary btn-xs" href="/sitemap">Sitemap</a> <a class="btn btn-primary btn-xs" href="/feed.xml">RSS</a> <a class="btn btn-primary btn-xs" href="//uk.linkedin.com/in/alexecollins">LinkedIn</a> </p> </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25388993-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script> </body> </html>