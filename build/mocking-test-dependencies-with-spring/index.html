<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1.0"> <meta name=google-site-verification content=459WLyNfyiKwT7T3IzdCjzIpNP-IVQSOb4tR8b2vQhI /> <title>Alex Collins - Mocking Test Dependencies with Spring</title> <link href="/css/bootstrap.min.css" media=screen rel=stylesheet /> <style type="text/css">
.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight {
  color: #faf6e4;
  background-color: #122b3b;
}
.highlight .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #6c8b9f;
  font-style: italic;
}
.highlight .cp {
  color: #b2fd6d;
  font-weight: bold;
  font-style: italic;
}
.highlight .err {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .gr {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .k, .highlight .kd, .highlight .kv {
  color: #f6dd62;
  font-weight: bold;
}
.highlight .o, .highlight .ow {
  color: #4df4ff;
}
.highlight .p, .highlight .pi {
  color: #4df4ff;
}
.highlight .gd {
  color: #cc0000;
}
.highlight .gi {
  color: #b2fd6d;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .kc {
  color: #f696db;
  font-weight: bold;
}
.highlight .kn {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kp {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kr {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gh {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gu {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kt {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .no {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nc {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nd {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nn {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .bp {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .ne {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nl {
  color: #ffb000;
  font-weight: bold;
}
.highlight .nt {
  color: #ffb000;
  font-weight: bold;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #f696db;
  font-weight: bold;
}
.highlight .ld {
  color: #f696db;
  font-weight: bold;
}
.highlight .ss {
  color: #f696db;
  font-weight: bold;
}
.highlight .s, .highlight .sb, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .sr, .highlight .s1 {
  color: #fff0a6;
  font-weight: bold;
}
.highlight .se {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .sc {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .si {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .nb {
  font-weight: bold;
}
.highlight .ni {
  color: #999999;
  font-weight: bold;
}
.highlight .w {
  color: #BBBBBB;
}
.highlight .nf {
  color: #a8e1fe;
}
.highlight .py {
  color: #a8e1fe;
}
.highlight .na {
  color: #a8e1fe;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi {
  color: #a8e1fe;
  font-weight: bold;
}	.article img {
		border: 1px solid #bbb;
		display: block;
		margin-left: auto;
		margin-right: auto;
		padding: 10px;
	}
	@media print {
		#disqus_thread, #sidebar {
    			display:none;
  		}
	}
</style> <link href="https://plus.google.com/101694420547181110548" rel=publisher /> </head> <body class="mocking-test-dependencies-with-spring mocking-test-dependencies-with-spring_index"> <div class=container> <div class=row> <div class="col-md-9 article"> <h1>Mocking Test Dependencies with Spring</h1> <table class=table> <tr> <td> <center> <a href="//selenium-webdriver-in-practice.github.io"><img src="/images/liang_cover100.jpg" class=thumbnail /></a> </center> </td> <td> <p class=well><b>Big news!</b> I've been working hard getting <b>Selenium WebDriver in Practice</b> ready and it is now available to buy on the <a href="//selenium-webdriver-in-practice.github.io">Manning Early Access Program</a>. It provides practical and useful techniques you can use with WebDriver, to get the very best out of it in your projects.</p> </td> </tr> </table> <p>I've been recently working on a large code base with a number of dependencies on other projects. Those projects provide classes used in our tests, but change often, which mean our test doubles regularly have to be updated.</p> <p>I'm going to talk about some interesting solutions to this problem, such as mocking beans, custom Spring namespace, and partial fakes using CGLIB, that can make this other testing situations faster and give you less maintenance overhead.</p> <p>Martin Fowler has a great post on the differences between <a href="//martinfowler.com/articles/mocksArentStubs.html">mocks, stub, fakes and dummies</a>, which you might want to read first.</p> <h2 id=test-dummys>Test Dummys</h2> <p>A dummy is a test double that is uses to fill parameter list; returning the most basic responses. Spring allows you to create beans using a factory. The factory can create a bean, so we're going to ask the factory to create a dummy. A dummy returns default responses.</p> <pre class="highlight xml">    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.alexecollins.testing.TestDummyFactoryBean"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">"com.alexecollins.testing.Example"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</pre> <p>A <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/java/com/alexecollins/testing/TestDummyFactoryBean.java">basic factory bean</a> creates a JDK proxy that returns default values.</p> <p>Firstly, we need a class to return default values:</p> <pre class="highlight java"><span class="kd">class</span> <span class="nc">Defaults</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">DEFAULTS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;();</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">char</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="sc">'\0'</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">byte</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">0</span><span class="n">f</span><span class="o">);</span>
        <span class="n">DEFAULTS</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">0</span><span class="n">d</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="n">Object</span> <span class="n">get</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">type</span><span class="o">.</span><span class="na">isPrimitive</span><span class="o">()</span> <span class="o">?</span> <span class="n">Defaults</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">:</span> <span class="n">type</span><span class="o">.</span><span class="na">isArray</span><span class="o">()</span> <span class="o">?</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestDummyFactoryBean</span> <span class="kd">implements</span> <span class="n">FactoryBean</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">object</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">TestDummyFactoryBean</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">object</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">clazz</span><span class="o">},</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="n">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">objects</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">Defaults</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="n">getObject</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">object</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">...</span>
</pre> <h2 id=test-namespace>Test Namespace</h2> <p>That's a nice start, but we're going to end up with a verbose XML document, three lines of boiler plate where we would have only one for a normal bean. How about this instead?</p> <pre class="highlight xml">	<span class="nt">&lt;test:dummy</span> <span class="na">id=</span><span class="s">"example"</span> <span class="na">class=</span><span class="s">"com.alexecollins.testing.Example"</span><span class="nt">/&gt;</span>
</pre> <p>We can create a Spring <a href="//docs.spring.io/spring/docs/2.5.6/reference/extensible-xml.html">namespace handler</a>. We need three things, firstly a <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/java/com/alexecollins/testing/TestNamespaceHandler.java">class that creates the dummies:</a></p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestNamespaceHandler</span> <span class="kd">extends</span> <span class="n">NamespaceHandlerSupport</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">registerBeanDefinitionParser</span><span class="o">(</span><span class="s">"dummy"</span><span class="o">,</span> <span class="k">new</span> <span class="n">AbstractSingleBeanDefinitionParser</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">Class</span> <span class="n">getBeanClass</span><span class="o">(</span><span class="n">Element</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">TestDummyFactoryBean</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="n">doParse</span><span class="o">(</span><span class="n">Element</span> <span class="n">element</span><span class="o">,</span> <span class="n">BeanDefinitionBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">builder</span><span class="o">.</span><span class="na">addConstructorArgValue</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"class"</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>And then we also need plumbing in terms of <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/resources/com/alexecollins/testing/test.xsd">XSD</a>, <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/resources/META-INF/spring.schemas">spring.schemas</a> and <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/resources/META-INF/spring.handlers">spring.handlers</a> files. I'm not going to cover the details, the Spring documentation do a great job of this.</p> <h2 id=mocks>Mocks</h2> <p>A mock is a test double with behaviour we can control. Mocks are more versatile than dummies. Mockito is a great library for mocking, and the <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/java/com/alexecollins/testing/MockFactoryBean.java">implementation is actually marginally less complex</a>. This is best demonstrated in a unit test:</p> <pre class="highlight java">    <span class="nd">@Autowired</span>
    <span class="n">Example</span> <span class="n">example</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testExample</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">when</span><span class="o">(</span><span class="n">example</span><span class="o">.</span><span class="na">intValue</span><span class="o">()).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">example</span><span class="o">.</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
</pre> <h2 id=partial-fake>Partial Fake</h2> <p>A fake is an implementation that takes "short-cuts", e.g. an in memory database. Some of the interfaces we rely on have a large number of methods, but we only use a minority of them. How can we create a class that implements a subset of the methods we need, and automatically return default (dummy) values for those we don't need? An abstract class will allow us to do that. Here's our interface:</p> <pre class="highlight java"><span class="kd">public</span> <span class="kt">int</span><span class="n">erface</span> <span class="n">Example</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="kt">void</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">int</span> <span class="kt">int</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">long</span> <span class="kt">long</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">float</span> <span class="kt">float</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">double</span> <span class="kt">double</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">byte</span> <span class="kt">byte</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">char</span> <span class="kt">char</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">short</span> <span class="kt">short</span><span class="n">Value</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="kt">boolean</span><span class="n">Value</span><span class="o">();</span>
    <span class="n">Object</span> <span class="n">objectValue</span><span class="o">();</span>
    <span class="n">Object</span><span class="o">[]</span> <span class="n">arrayValue</span><span class="o">();</span>
<span class="o">}</span>
</pre> <p>And here's our class:</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PartialFakeExample</span> <span class="kd">implements</span> <span class="n">Example</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="kt">long</span><span class="n">Value</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="mi">1</span><span class="n">l</span><span class="o">;}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="kt">int</span><span class="n">Value</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="mi">1</span><span class="o">;}</span>
<span class="o">}</span>
</pre> <p>We have a problem here, JDK proxies can only subclass interfaces. But we can use CGLIB. We create <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/main/java/com/alexecollins/testing/PartialFakeFactoryBean.java">an enhancer</a> that will call the method on the abstract class if it exists, or the default value if not.</p> <pre class="highlight java">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">newObject</span><span class="p">(</span><span class="kd">final</span> <span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Enhancer</span> <span class="n">enhancer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Enhancer</span><span class="o">();</span>
        <span class="n">enhancer</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="n">enhancer</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="k">new</span> <span class="n">MethodInterceptor</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="kt">int</span><span class="n">ercept</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">,</span> <span class="n">MethodProxy</span> <span class="n">proxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">Method</span> <span class="n">clazzMethod</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">());</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">(</span><span class="n">clazzMethod</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()))</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">proxy</span><span class="o">.</span><span class="na">invokeSuper</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">Defaults</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="n">enhancer</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
    <span class="o">}</span>
</pre> <p>Again, we can create an XML namespace for a nice, tidy XML:</p> <pre class="highlight xml">    <span class="nt">&lt;test:fake</span> <span class="na">id=</span><span class="s">"example1"</span> <span class="na">class=</span><span class="s">"com.alexecollins.testing.PartialFakeExample"</span><span class="nt">/&gt;</span>        
</pre> <p>The partial fake is the most versatile of the doubles here, with a fully defined set of methods, it becomes a normal fake, it can provide stubbed answers, or just defaults like a dummy. A dummy is a stub returning only default answers.</p> <h2 id=stubs>Stubs</h2> <p>To complete our set of doubles, we'll need stubs. Stubs return canned responses. This is similar to fakes, but unlike our fakes, they are not partial. One very good implementation is <a href="https://github.com/alexec/test-double-deps-with-spring/blob/master/src/test/java/com/alexecollins/testing/StubExample.java">a normal bean</a>, unlike any special XML, it's type-safe, easy to use and easy to understand. As a stub provides canned responses, we might expect it to have a no-args constructor, this suggests the following implementation for the factory:</p> <pre class="highlight java">    <span class="kd">public</span> <span class="nf">StubFactoryBean</span><span class="p">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
    <span class="o">}</span>
</pre> <pre class="highlight xml">    <span class="nt">&lt;test:stub</span> <span class="na">id=</span><span class="s">"example"</span> <span class="na">class=</span><span class="s">"com.alexecollins.testing.StubExample"</span><span class="nt">/&gt;</span>
</pre> <h2 id=ignoring-missing-dependencies>Ignoring Missing Dependencies</h2> <p>A number of classes imported have more auto-wired fields than that methods we call depend on. We can modify the context to allow them to be non-mandatory, making our tests more robust to changes in those dependencies. This is a simple one:</p> <pre class="highlight xml">        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"requiredParameterValue"</span> <span class="na">value=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
</pre> <h2 id=test-lifecycle>Test Lifecycle</h2> <p>Spring re-uses the context between tests. This means the beans become "dirty". You can use @DirtiesContext to tear-down and rebuild the context between test, but it's expensive and can lead to out-of-perm-gen problems. Instead, we want an annotation similar to JUnit's @Before annotation, which indicates that a method should be called before each test.</p> <pre class="highlight java"><span class="nd">@Inherited</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Before</span> <span class="o">{</span>
<span class="o">}</span>
</pre> <p>A class that stores those methods, and then class them as part of the test lifecyle:</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DoubleManagerTestExecutionListener</span> <span class="kd">extends</span> <span class="n">AbstractTestExecutionListener</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Target</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Object</span> <span class="n">o</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">Method</span> <span class="n">m</span><span class="o">;</span>

        <span class="kd">private</span> <span class="n">Target</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">Method</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">o</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Target</span><span class="o">&gt;</span> <span class="n">targets</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">beforeTestMethod</span><span class="o">(</span><span class="n">TestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">targets</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Target</span><span class="o">&gt;();</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">Object</span> <span class="n">o</span> <span class="o">:</span> <span class="n">testContext</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getBeansOfType</span><span class="o">(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">m</span> <span class="o">:</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethods</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">Before</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">targets</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Target</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">m</span><span class="o">));</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Target</span> <span class="n">target</span> <span class="o">:</span> <span class="n">targets</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">target</span><span class="o">.</span><span class="na">m</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">target</span><span class="o">.</span><span class="na">o</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>The the test double can use this to reset itself:</p> <pre class="highlight java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ManagedExample</span> <span class="kd">implements</span> <span class="n">Example</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="kt">int</span><span class="n">Value</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="o">...</span>
</pre> <p>This is best demonstrated by an example test:</p> <pre class="highlight java"><span class="nd">@TestExecutionListeners</span><span class="o">({</span>
        <span class="c1">// if we override, we must specify all the ones we want, shame we can't say "please use the defaults"</span>
        <span class="n">DependencyInjectionTestExecutionListener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">DoubleManagerTestExecutionListener</span><span class="o">.</span><span class="na">class</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DoubleManagerTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">Example</span> <span class="n">example</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">testSetUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">example</span><span class="o">.</span><span class="na">intValue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre> <p>OK. So I hope you enjoyed this post, and you get some good ideas from it. The code can be <a href="https://github.com/alexec/test-double-deps-with-spring">found on Github</a> as usual.</p> <p>References/Further Reading</p> <ul> <li><a href="/tutorial-junit-rule/">Test support for Tomcat and Spring</a>.</li> <li><a href="//martinfowler.com/articles/mocksArentStubs.html">Mocks Aren't Stubs</a> </li> <li><a href="//docs.spring.io/spring/docs/2.5.6/reference/extensible-xml.html">Spring Extensible XML</a></li> </ul> <h4>Related</h4> <ol> <li><a href="/tutorial-integration-testing-selenium-part-1/">Tutorial: Integration Testing with Selenium - Part 1</a></li> <li><a href="/tomcat-context-junit-rule/">Tomcat Context JUnit @Rule</a></li> <li><a href="/tutorial-integration-testing-selenium-part-2/">Tutorial: Integration Testing with Selenium - Part 2</a></li> <li><a href="/tutorial-junit-rule/">Tutorial: JUnit @Rule</a></li> <li><a href="/spring-boot-performance/">Spring Boot Performance</a></li> </ol> <div id=disqus_thread></div> <script>
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alexecollins'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> <div class=col-md-3 id=sidebar> <center> <h2>Alex Collins</h2> <p> <a href="/"><img src="/images/alex-collins-circle.png"/></a> </p> </center> <p> Java technical lead and solutions architect in London for the UK IT industry for over ten years. <a href="/about-me">more...</a> </p> <h4>Docker Maven Plugin</h4> <p>Version 2.11.7 released, <a href="https://github.com/alexec/docker-maven-plugin/blob/master/CHANGELOG.md">more...</a></p> <pre style="font-size:50%">&lt;dependency&gt;
  &lt;groupId&gt;com.alexecollins.docker&lt;/groupId&gt;
  &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.11.7&lt;/version&gt;
&lt;/dependency&gt;</pre> <h4>Recent</h4> <ul> <li><a href="/developing-with-docker-debug-container/">Developing With Docker - The Debug Container</a> <span>Dec 9</span></li> <li><a href="/developing-with-docker-proxy-container/">Developing With Docker - Using A Proxy Container To Make Development Easier</a> <span>Nov 28</span></li> <li><a href="/practical-domain-specific-language-tutorial/">Practical Java Domain Specific Language Tutorial</a> <span>Sep 19</span></li> <li><a href="/sonarqube-and-java-8/">Sonarqube And Java 8</a> <span>Sep 17</span></li> <li><a href="/spring-boot-performance/">Spring Boot Performance</a> <span>Sep 5</span></li> </ul> <h4>Tags</h4> <a href="/tags/ci/">ci</a> (3)</a>&nbsp;&nbsp; <a href="/tags/concurrency/">concurrency</a> (4)</a>&nbsp;&nbsp; <a href="/tags/docker/">docker</a> (12)</a>&nbsp;&nbsp; <a href="/tags/gist/">gist</a> (13)</a>&nbsp;&nbsp; <a href="/tags/groovy/">groovy</a> (4)</a>&nbsp;&nbsp; <a href="/tags/java/">java</a> (48)</a>&nbsp;&nbsp; <a href="/tags/jmeter/">jmeter</a> (3)</a>&nbsp;&nbsp; <a href="/tags/junit/">junit</a> (7)</a>&nbsp;&nbsp; <a href="/tags/links/">links</a> (14)</a>&nbsp;&nbsp; <a href="/tags/maven/">maven</a> (18)</a>&nbsp;&nbsp; <a href="/tags/oped/">oped</a> (8)</a>&nbsp;&nbsp; <a href="/tags/performance/">performance</a> (6)</a>&nbsp;&nbsp; <a href="/tags/plaf/">plaf</a> (14)</a>&nbsp;&nbsp; <a href="/tags/ruby/">ruby</a> (3)</a>&nbsp;&nbsp; <a href="/tags/selenium/">selenium</a> (9)</a>&nbsp;&nbsp; <a href="/tags/software/">software</a> (10)</a>&nbsp;&nbsp; <a href="/tags/spring/">spring</a> (7)</a>&nbsp;&nbsp; <a href="/tags/swing/">swing</a> (15)</a>&nbsp;&nbsp; <a href="/tags/testing/">testing</a> (23)</a>&nbsp;&nbsp; <a href="/tags/tips/">tips</a> (4)</a>&nbsp;&nbsp; <a href="/tags/tomcat/">tomcat</a> (3)</a>&nbsp;&nbsp; <a href="/tags/unix/">unix</a> (6)</a>&nbsp;&nbsp; <a href="/tags/web/">web</a> (4)</a>&nbsp;&nbsp; </hr/> <p> <a class="btn btn-primary btn-xs" href="/sitemap">Sitemap</a> <a class="btn btn-primary btn-xs" href="/feed.xml">RSS</a> <a class="btn btn-primary btn-xs" href="//uk.linkedin.com/in/alexecollins">LinkedIn</a> </p> </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25388993-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script> </body> </html>