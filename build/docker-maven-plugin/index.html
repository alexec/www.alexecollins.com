<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1.0"> <meta name=google-site-verification content=459WLyNfyiKwT7T3IzdCjzIpNP-IVQSOb4tR8b2vQhI /> <title>Alex Collins - Docker Maven Plugin</title> <link href="/css/bootstrap.min.css" media=screen rel=stylesheet /> <style type="text/css">
.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight {
  color: #faf6e4;
  background-color: #122b3b;
}
.highlight .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #6c8b9f;
  font-style: italic;
}
.highlight .cp {
  color: #b2fd6d;
  font-weight: bold;
  font-style: italic;
}
.highlight .err {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .gr {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .k, .highlight .kd, .highlight .kv {
  color: #f6dd62;
  font-weight: bold;
}
.highlight .o, .highlight .ow {
  color: #4df4ff;
}
.highlight .p, .highlight .pi {
  color: #4df4ff;
}
.highlight .gd {
  color: #cc0000;
}
.highlight .gi {
  color: #b2fd6d;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .kc {
  color: #f696db;
  font-weight: bold;
}
.highlight .kn {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kp {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kr {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gh {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gu {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kt {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .no {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nc {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nd {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nn {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .bp {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .ne {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nl {
  color: #ffb000;
  font-weight: bold;
}
.highlight .nt {
  color: #ffb000;
  font-weight: bold;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #f696db;
  font-weight: bold;
}
.highlight .ld {
  color: #f696db;
  font-weight: bold;
}
.highlight .ss {
  color: #f696db;
  font-weight: bold;
}
.highlight .s, .highlight .sb, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .sr, .highlight .s1 {
  color: #fff0a6;
  font-weight: bold;
}
.highlight .se {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .sc {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .si {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .nb {
  font-weight: bold;
}
.highlight .ni {
  color: #999999;
  font-weight: bold;
}
.highlight .w {
  color: #BBBBBB;
}
.highlight .nf {
  color: #a8e1fe;
}
.highlight .py {
  color: #a8e1fe;
}
.highlight .na {
  color: #a8e1fe;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi {
  color: #a8e1fe;
  font-weight: bold;
}	.article img {
		border: 1px solid #bbb;
		display: block;
		margin-left: auto;
		margin-right: auto;
		padding: 10px;
	}
	@media print {
		#disqus_thread, #sidebar {
    			display:none;
  		}
	}
</style> <link href="https://plus.google.com/101694420547181110548" rel=publisher /> </head> <body class="docker-maven-plugin docker-maven-plugin_index"> <div class=container> <div class=row> <div class="col-md-9 article"> <h1>Docker Maven Plugin</h1> <table class=table> <tr> <td> <center> <a href="//selenium-webdriver-in-practice.github.io"><img src="/images/liang_cover100.jpg" class=thumbnail /></a> </center> </td> <td> <p class=well><b>Big news!</b> I've been working hard getting <b>Selenium WebDriver in Practice</b> ready and it is now available to buy on the <a href="//selenium-webdriver-in-practice.github.io">Manning Early Access Program</a>. It provides practical and useful techniques you can use with WebDriver, to get the very best out of it in your projects.</p> </td> </tr> </table> <p>I've been beavering away for the last few days to create the missing Maven plugin for Docker. I'd previously created a plugin for VirtualBox that manages the creation of virtual machines. Based my ideas on that worked well there (configuration files, templates) but without the ones that don't (XML, patch files, building base boxes). </p> <h2 id=what-does-it-add-to-vanilla-docker>What does it add to vanilla Docker?</h2> <p>While Docker makes it easy to create containers and set them up, it provides little in the way of orchestration of multiple containers, that is left up to you to do. </p> <p>This plugin will, based on some YAML config and Dockerfile's, build your containers, expose ports onto the host, link them together and start/stop them for your integration tests, all in concert.</p> <p>Think of it as a mixture of a packaging program with a bit of the Cargo plugin thrown in.</p> <h2 id=what-doesnt-it-add>What doesn't it add?</h2> <p>Anything the <code>docker</code> command will do for you. E.g. if you want to attach to a container, start or start a single container, you can do that with the docker command. No need to re-invent that.</p> <h2 id=sounds-great-how-about-a-short-tutorial>Sounds great! How about a short tutorial?</h2> <p>The project has an example which creates a container that run a standalone JAR (<a href="//martinfowler.com/articles/microservices.html">they're so hot right now!</a>) in <a href="https://github.com/alexec/drop-wizard-in-a-box">here</a>. </p> <p>Checkout the code and quickly build it and run the tests:</p> <pre class="highlight plaintext">git clone https://github.com/alexec/drop-wizard-in-a-box.git
cd drop-wizard-in-a-box
mvn install -Prun-its
</pre> <p>You'll have the example ready to examine:</p> <pre class="highlight plaintext">$ find . -type f
./hello-world.yml
./pom.xml
./src/main/docker/app/conf.yml
./src/main/docker/app/Dockerfile
./src/main/docker/app/run.sh
./src/main/docker/data/conf.yml
./src/main/docker/data/Dockerfile
./src/main/docker/mysql/conf.yml
./src/main/docker/mysql/Dockerfile
./src/main/java/com/example/helloworld/HelloWorldConfiguration.java
./src/main/java/com/example/helloworld/HelloWorldResource.java
./src/main/java/com/example/helloworld/HelloWorldService.java
./src/main/java/com/example/helloworld/model/Person.java
./src/main/java/com/example/helloworld/PeopleDAO.java
./src/main/java/com/example/helloworld/Saying.java
./src/main/java/com/example/helloworld/TemplateHealthCheck.java
./src/main/resources/migrations.xml
...
</pre> <p>What have we got here? It's a pretty simple Drop-Wizard Hello World Micro-Service. Or in more simple words, it's a standalone JAR that run a REST service. It's adapted from the <a href="https://dropwizard.github.io/dropwizard/getting-started.html">example in the documentation</a>.</p> <p>Our app needs it's database set-up, so run this:</p> <pre class="highlight plaintext">$ java -jar target/drop-wizard-in-a-box-1.0.0-SNAPSHOT.jar db migrate hello-world.yml
Can not read response from server. 
</pre> <p>It's failed to run - that's not very impressive! That's because, you need a MySQL server running on port 3306, to set-up the database. Lets use the plugin to build this for us:</p> <pre class="highlight plaintext">$ mvn docker:package
..
$ docker images | head
REPOSITORY                                                   TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
registry/drop-wizard-in-a-box-app                            1.0.0-SNAPSHOT      76614734bdcd        3 minutes ago       461 MB
</pre> <p>There we go, a set-up and configured container which we can start:</p> <pre class="highlight plaintext">$ docker run -i -p 3306:3306 registry/drop-wizard-in-a-box-mysql:1.0.0-SNAPSHOT
</pre> <p>Now we need to set-up the database:</p> <pre class="highlight plaintext">$ java -jar target/drop-wizard-in-a-box-1.0.0-SNAPSHOT.jar db migrate hello-world.yml
...
$ java -jar target/drop-wizard-in-a-box-1.0.0-SNAPSHOT.jar server hello-world.yml
</pre> <p>Now lets test it, at <a href="//localhost:8080/hello-world">http://localhost:8080/hello-world</a> you should see:</p> <pre class="highlight json"><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">"content"</span><span class="p">:</span><span class="s2">"Hello, Stranger!"</span><span class="p">}</span><span class="w">
</span></pre> <p>Great! Lets have a look and the config is <code>src/main/docker</code>. Each sub-directory is for a single container. There are at least two files in each, a <code>Dockerfile</code>, which should not container any surprises:</p> <pre class="highlight plaintext">FROM dockerfile/java:oracle-java7

ADD ${project.build.finalName}.jar /
ADD hello-world.yml /
ADD run.sh /

RUN chmod +x run.sh

CMD ["./run.sh"]

EXPOSE 8080
EXPOSE 8081
</pre> <p>The second file is <code>conf.yml</code>, lets take a closer look:</p> <pre class="highlight yaml"><span class="s">packaging</span><span class="pi">:</span>
  <span class="s">add</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">target/${project.build.finalName}.jar</span>
    <span class="pi">-</span> <span class="s">hello-world.yml</span>
<span class="s">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">8080</span>
<span class="s">links</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">mysql</span>
</pre> <p>This is additional config needed to create and start the container. It's a bit like a recipe. Look at the ingredients:</p> <ul> <li><code>package/add</code> is a list of additional files to use for our container, in this case, we add the JAR file and some YAML config.</li> <li><code>ports</code> is a list of port to expose on the host. Ports are exposed by default between containers.</li> <li><code>links</code> is a list of linked containers.</li> </ul> <p>The hawk-eyed amongst you will have noticed that <code>run.sh</code> is also in the directory. Lets look at that.</p> <pre class="highlight shell"><span class="c">#!/bin/sh</span>
<span class="nb">set</span> -eux

sed -i <span class="s2">"s/localhost:3306/</span><span class="nv">$EXAMPLE_MYSQL_PORT_3306_TCP_ADDR</span><span class="s2">:3306/"</span> hello-world.yml

java -jar <span class="k">${</span><span class="nv">project</span><span class="p">.build.finalName</span><span class="k">}</span>.jar db migrate hello-world.yml
java -jar <span class="k">${</span><span class="nv">project</span><span class="p">.build.finalName</span><span class="k">}</span>.jar server hello-world.yml
</pre> <p>Docker reveals the exposed ports of a linked container as environment variables. As the plugin uses the container name as the alias, we can <code>sed</code> it into place. </p> <p>The plugin does more than just building containers. It'll start and stop them for tests too. You can try this out yourself:</p> <pre class="highlight plaintext">$ mvn verify
...
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running com.example.helloworld.HelloWorldServiceIT
...
[INFO] BUILD SUCCESS
...
</pre> <p>Horay! We've created a tested docker image ready to be pushed to a repository and deployed!</p> <pre class="highlight plaintext">$ mvn docker:push
</pre> <div id=disqus_thread></div> <script>
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alexecollins'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> <div class=col-md-3 id=sidebar> <center> <h2>Alex Collins</h2> <p> <a href="/"><img src="/images/alex-collins-circle.png"/></a> </p> </center> <p> Java technical lead and solutions architect in London for the UK IT industry for over ten years. <a href="/about-me">more...</a> </p> <h4>Docker Maven Plugin</h4> <p>Version 2.11.4 released, <a href="https://github.com/alexec/docker-maven-plugin/blob/master/CHANGELOG.md">more...</a></p> <pre style="font-size:50%">&lt;dependency&gt;
  &lt;groupId&gt;com.alexecollins.docker&lt;/groupId&gt;
  &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.11.4&lt;/version&gt;
&lt;/dependency&gt;</pre> <h4>Related</h4> <ol> <li><a href="/migrating-to-circleci/">Migrating to CircleCI</a></li> <li><a href="/docker-maven-plugin-presentation-at-docker-london/">Docker Maven Plugin Presentation At Docker London</a></li> <li><a href="/elastic-search-in-a-box-with-docker/">Search In A Box With Docker, Elastic Search, Spring Boot, and Selenium</a></li> <li><a href="/docker-persistence/">Docker - Persistence</a></li> <li><a href="/introduction-to-docker-slides/">Introduction to Docker Slides</a></li> </ol> <h4>Recent</h4> <ul> <li><a href="/developing-with-docker-proxy-container/">Developing With Docker - Using A Proxy Container To Make Development Easier</a> <span>Nov 28</span></li> <li><a href="/practical-domain-specific-language-tutorial/">Practical Java Domain Specific Language Tutorial</a> <span>Sep 19</span></li> <li><a href="/sonarqube-and-java-8/">Sonarqube And Java 8</a> <span>Sep 17</span></li> <li><a href="/spring-boot-performance/">Spring Boot Performance</a> <span>Sep 5</span></li> <li><a href="/testing-anti-patterns/">Testing Anti-Patterns</a> <span>Jun 23</span></li> </ul> <h4>Tags</h4> <a href="/tags/ci/">ci</a> (3)</a>&nbsp;&nbsp; <a href="/tags/concurrency/">concurrency</a> (4)</a>&nbsp;&nbsp; <a href="/tags/docker/">docker</a> (11)</a>&nbsp;&nbsp; <a href="/tags/gist/">gist</a> (13)</a>&nbsp;&nbsp; <a href="/tags/groovy/">groovy</a> (4)</a>&nbsp;&nbsp; <a href="/tags/java/">java</a> (48)</a>&nbsp;&nbsp; <a href="/tags/jmeter/">jmeter</a> (3)</a>&nbsp;&nbsp; <a href="/tags/junit/">junit</a> (7)</a>&nbsp;&nbsp; <a href="/tags/links/">links</a> (14)</a>&nbsp;&nbsp; <a href="/tags/maven/">maven</a> (18)</a>&nbsp;&nbsp; <a href="/tags/oped/">oped</a> (8)</a>&nbsp;&nbsp; <a href="/tags/performance/">performance</a> (6)</a>&nbsp;&nbsp; <a href="/tags/plaf/">plaf</a> (14)</a>&nbsp;&nbsp; <a href="/tags/ruby/">ruby</a> (3)</a>&nbsp;&nbsp; <a href="/tags/selenium/">selenium</a> (9)</a>&nbsp;&nbsp; <a href="/tags/software/">software</a> (10)</a>&nbsp;&nbsp; <a href="/tags/spring/">spring</a> (7)</a>&nbsp;&nbsp; <a href="/tags/swing/">swing</a> (15)</a>&nbsp;&nbsp; <a href="/tags/testing/">testing</a> (23)</a>&nbsp;&nbsp; <a href="/tags/tips/">tips</a> (4)</a>&nbsp;&nbsp; <a href="/tags/tomcat/">tomcat</a> (3)</a>&nbsp;&nbsp; <a href="/tags/unix/">unix</a> (6)</a>&nbsp;&nbsp; <a href="/tags/web/">web</a> (4)</a>&nbsp;&nbsp; </hr/> <p> <a class="btn btn-primary btn-xs" href="/sitemap">Sitemap</a> <a class="btn btn-primary btn-xs" href="/feed.xml">RSS</a> <a class="btn btn-primary btn-xs" href="//uk.linkedin.com/in/alexecollins">LinkedIn</a> </p> </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25388993-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script> </body> </html>