<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1.0"> <meta name=google-site-verification content=459WLyNfyiKwT7T3IzdCjzIpNP-IVQSOb4tR8b2vQhI /> <title>Alex Collins - Migrating to CircleCI</title> <link href="/css/bootstrap.min.css" media=screen rel=stylesheet /> <style type="text/css">
.highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight {
  color: #faf6e4;
  background-color: #122b3b;
}
.highlight .gl {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #6c8b9f;
  font-style: italic;
}
.highlight .cp {
  color: #b2fd6d;
  font-weight: bold;
  font-style: italic;
}
.highlight .err {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .gr {
  color: #fefeec;
  background-color: #cc0000;
}
.highlight .k, .highlight .kd, .highlight .kv {
  color: #f6dd62;
  font-weight: bold;
}
.highlight .o, .highlight .ow {
  color: #4df4ff;
}
.highlight .p, .highlight .pi {
  color: #4df4ff;
}
.highlight .gd {
  color: #cc0000;
}
.highlight .gi {
  color: #b2fd6d;
}
.highlight .ge {
  font-style: italic;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gt {
  color: #dee5e7;
  background-color: #4e5d62;
}
.highlight .kc {
  color: #f696db;
  font-weight: bold;
}
.highlight .kn {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kp {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kr {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gh {
  color: #ffb000;
  font-weight: bold;
}
.highlight .gu {
  color: #ffb000;
  font-weight: bold;
}
.highlight .kt {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .no {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nc {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nd {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nn {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .bp {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .ne {
  color: #b2fd6d;
  font-weight: bold;
}
.highlight .nl {
  color: #ffb000;
  font-weight: bold;
}
.highlight .nt {
  color: #ffb000;
  font-weight: bold;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #f696db;
  font-weight: bold;
}
.highlight .ld {
  color: #f696db;
  font-weight: bold;
}
.highlight .ss {
  color: #f696db;
  font-weight: bold;
}
.highlight .s, .highlight .sb, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .sr, .highlight .s1 {
  color: #fff0a6;
  font-weight: bold;
}
.highlight .se {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .sc {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .si {
  color: #4df4ff;
  font-weight: bold;
}
.highlight .nb {
  font-weight: bold;
}
.highlight .ni {
  color: #999999;
  font-weight: bold;
}
.highlight .w {
  color: #BBBBBB;
}
.highlight .nf {
  color: #a8e1fe;
}
.highlight .py {
  color: #a8e1fe;
}
.highlight .na {
  color: #a8e1fe;
}
.highlight .nv, .highlight .vc, .highlight .vg, .highlight .vi {
  color: #a8e1fe;
  font-weight: bold;
}	.article img {
		border: 1px solid #bbb;
		display: block;
		margin-left: auto;
		margin-right: auto;
		padding: 10px;
	}
	@media print {
		#disqus_thread, #sidebar {
    			display:none;
  		}
	}
</style> <link href="https://plus.google.com/101694420547181110548" rel=publisher /> </head> <body class="migrating-to-circleci migrating-to-circleci_index"> <div class=container> <div class=row> <div class="col-md-9 article"> <h1>Migrating to CircleCI</h1> <table class=table> <tr> <td> <center> <a href="//selenium-webdriver-in-practice.github.io"><img src="/images/liang_cover100.jpg" class=thumbnail /></a> </center> </td> <td> <p class=well><b>Big news!</b> I've been working hard getting <b>Selenium WebDriver in Practice</b> ready and it is now available to buy on the <a href="//selenium-webdriver-in-practice.github.io">Manning Early Access Program</a>. It provides practical and useful techniques you can use with WebDriver, to get the very best out of it in your projects.</p> </td> </tr> </table> <h2 id=oveview>Oveview</h2> <p>This weekend I've been migrating my builds to <a href="https://circleci.com">CircleCI</a> from <a href="https://travis-ci.org">TravisCI</a>. </p> <p>In this post:</p> <ul> <li>I'll tell you why I moved.</li> <li>What I like about it.</li> <li>What problems I had.</li> </ul> <p>So, why would I do this?</p> <ul> <li>CircleCI has Docker container support, which I really need for my Docker plugin builds.</li> <li>CircleCI has great support for JUnit XML reports.</li> <li>I need to run integration tests.</li> <li>I wanted to reduce the amount of time I spent waiting for integration builds on my laptop to run.</li> </ul> <p>I've found it a pleasant, if time consuming task. I've also been able to take time to improve the builds themselves:</p> <ul> <li>Support for <a href="//saucelabs.com">Saucelabs</a> in my WebDriver builds.</li> <li>Run Docker integration tests.</li> <li>Deploy snapshots to <a href="https://oss.sonatype.org">Nexus OSS repository</a>.</li> <li>Correct my builds together into a pipeline.</li> </ul> <h3 id=sharing-build-artefacts>Sharing Build Artefacts</h3> <p>The first problem I encountered wast that I wanted to share artefacts between builds. I thought that this was going to be painful, but I resolved really quickly and securely with Maven. Once you've got your OSS keys set-up, you need to do a couple of things:</p> <ol> <li>Create a <code>settings.xml</code> to use for your build.</li> <li>Pass the secure settings via environment variables.</li> <li>Use the new <code>settings.xml</code> in your <code>circle.yml</code>.</li> </ol> <p>You can do this by adding this to the root of your source code:</p> <pre class="highlight plaintext">&lt;settings xmlns="http://maven.apache.org/SETTINGS/1.1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd"&gt;
    &lt;servers&gt;
        &lt;server&gt;
            &lt;id&gt;sonatype-nexus-snapshots&lt;/id&gt;
            &lt;username&gt;${env.SONATYPE_USER}&lt;/username&gt;
            &lt;password&gt;${env.SONATYPE_PASSWORD}&lt;/password&gt;
        &lt;/server&gt;
        &lt;server&gt;
            &lt;id&gt;sonatype-nexus-staging&lt;/id&gt;
            &lt;username&gt;${env.SONATYPE_USER}&lt;/username&gt;
            &lt;password&gt;${env.SONATYPE_PASSWORD}&lt;/password&gt;
        &lt;/server&gt;
    &lt;/servers&gt;
    &lt;profiles&gt;
        &lt;profile&gt;
            &lt;id&gt;gpg&lt;/id&gt;
            &lt;properties&gt;
                &lt;gpg.passphrase&gt;${env.GPG_PASSPHRASE}&lt;/gpg.passphrase&gt;
            &lt;/properties&gt;
        &lt;/profile&gt;
        &lt;profile&gt;
            &lt;id&gt;sonatype-staging&lt;/id&gt;
            &lt;repositories&gt;
                &lt;repository&gt;
                    &lt;id&gt;sonatype-staging&lt;/id&gt;
                    &lt;url&gt;https://oss.sonatype.org/service/local/staging/deploy/maven2/&lt;/url&gt;
                    &lt;layout&gt;default&lt;/layout&gt;
                    &lt;releases&gt;
                        &lt;enabled&gt;true&lt;/enabled&gt;
                    &lt;/releases&gt;
                &lt;/repository&gt;
            &lt;/repositories&gt;
        &lt;/profile&gt;
    &lt;/profiles&gt;
    &lt;activeProfiles&gt;
        &lt;activeProfile&gt;gpg&lt;/activeProfile&gt;
        &lt;activeProfile&gt;sonatype-staging&lt;/activeProfile&gt;
    &lt;/activeProfiles&gt;
&lt;/settings&gt;
</pre> <p>This externalises the usernames and passwords into environment variables that you can securely add to you build. I use the same <code>settings.xml</code> file locally as I do remotely. This means you need to add your them to you <code>~/.bash_profile</code>:</p> <pre class="highlight plaintext">export SONATYPE_USER=secret
export SONATYPE_PASSWORD=secret
export GPG_PASSPHRASE=secret
</pre> <p>You can them update your <code>circle.yml</code> do deploy:</p> <pre class="highlight plaintext">test:
 override:
  - mvn deploy -Prun-its -s settings.xml
</pre> <p>To complete this the deployment of your artefacts, you need to add your keys into the web interface.</p> <p>For another build to consume them in another build you just need to add the repository to your <code>pom.xml</code>:</p> <pre class="highlight plaintext">&lt;repositories&gt;
    &lt;repository&gt;
        &lt;id&gt;sonatype-snapshots&lt;/id&gt;
        &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots/&lt;/url&gt;
        &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
        &lt;/snapshots&gt;
    &lt;/repository&gt;
&lt;/repositories&gt;
</pre> <p>And, if you have a plugin dependency, you'll also need to add that:</p> <pre class="highlight plaintext">&lt;pluginRepositories&gt;
    &lt;pluginRepository&gt;
        &lt;id&gt;sonatype-snapshots&lt;/id&gt;
        &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots/&lt;/url&gt;
        &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
        &lt;/snapshots&gt;
    &lt;/pluginRepository&gt;
&lt;/pluginRepositories&gt;
</pre> <p>Finally, you need to tell CircleCI about how to resolve dependencies in <code>circle.yml</code>:</p> <pre class="highlight plaintext">dependencies:
 override: 
  - mvn dependency:resolve -s settings.xml
</pre> <h3 id=multi-module-build-dependencies>Multi-module Build Dependencies</h3> <p>By default, CircleCI tries to resolve dependencies before the build. This becomes a problem if you have a multi-module build, as those dependencies will not exist! To fix this, override the set-up to install them locally:</p> <pre class="highlight plaintext">dependencies:
 override: 
  - mvn install -DskipTests     
</pre> <h3 id=stopping-unwanted-services>Stopping Unwanted Services</h3> <p>One of my builds creates a MySQL Docker container listening on port 3306. But when I ran it on CircleCI, it produced a bind error as MySQL was already running. Stop it as follows (you must use <code>sudo</code>):</p> <pre class="highlight plaintext">test:
 override:
  - sudo service mysql stop
</pre> <h3 id=test-reports>Test Reports</h3> <p>CircleCI can collect test reports in the ubiquitous JUnit format. Just add a few lines to your <code>circle.yml</code>:</p> <pre class="highlight plaintext">test:
 post:
  - mkdir -p $CIRCLE_TEST_REPORTS/junit/
  - find . -type f -regex ".*/target/.*-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
</pre> <p>This will collect both Surefire and Failsafe reports.</p> <h3 id=removing-docker-containers>Removing Docker Containers</h3> <p>I was seeing this error a lot:</p> <pre class="highlight plaintext">Driver btrfs failed to remove root filesystem 39ae….95ee: Failed to destroy btrfs snapshot: operation not permitted
</pre> <p>The Docker set-up does not support removal of containers. You need to hack around this in your build if you need to do it. </p> <h3 id=creating-a-build-pipeline>Creating A Build Pipeline</h3> <p>You can create a build pipeline that starts one build when another finishes. To do this, you can create a script that uses their API. I called mine <code>circle.sh</code>:</p> <pre class="highlight shell"><span class="c">#!/bin/bash -ex</span>

curl -v -X POST https://circleci.com/api/v1/project/alexec/<span class="nv">$1</span>/tree/master?circle-token<span class="o">=</span><span class="nv">$CIRCLE_TOKEN</span>
</pre> <p>You need to then create an API token and update the environment variables for your build. Finally, you can kick it off in your <code>circle.yml</code>:</p> <pre class="highlight plaintext">deployment:
 staging:
   branch: master
   commands:
	  - ./circle.sh start_build docker-maven-plugin
</pre> <h2 id=summary>Summary</h2> <p>I've had a really good experience with CircleCI. Particularly, I've found it really fast. There are a few rough edges. If you've come from using Jenkins you may miss its massive ecosystem of plugins.</p> <p>I've put my <a href="https://github.com/alexec/circleci">build scripts onto Github</a>.</p> <div id=disqus_thread></div> <script>
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'alexecollins'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script> <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> <div class=col-md-3 id=sidebar> <center> <h2>Alex Collins</h2> <p> <a href="/"><img src="/images/alex-collins-circle.png"/></a> </p> </center> <p> Java technical lead and solutions architect in London for the UK IT industry for over ten years. <a href="/about-me">more...</a> </p> <h4>Docker Maven Plugin</h4> <p>Version 2.11.4 released, <a href="https://github.com/alexec/docker-maven-plugin/blob/master/CHANGELOG.md">more...</a></p> <pre style="font-size:50%">&lt;dependency&gt;
  &lt;groupId&gt;com.alexecollins.docker&lt;/groupId&gt;
  &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;2.11.4&lt;/version&gt;
&lt;/dependency&gt;</pre> <h4>Related</h4> <ol> <li><a href="/polyglot-maven-first-steps/">Polyglot Maven First Steps</a></li> <li><a href="/docker-maven-plugin-presentation-at-docker-london/">Docker Maven Plugin Presentation At Docker London</a></li> <li><a href="/docker-maven-plugin/">Docker Maven Plugin</a></li> <li><a href="/elastic-search-in-a-box-with-docker/">Search In A Box With Docker, Elastic Search, Spring Boot, and Selenium</a></li> <li><a href="/docker-persistence/">Docker - Persistence</a></li> </ol> <h4>Recent</h4> <ul> <li><a href="/practical-domain-specific-language-tutorial/">Practical Java Domain Specific Language Tutorial</a> <span>Sep 19</span></li> <li><a href="/sonarqube-and-java-8/">Sonarqube And Java 8</a> <span>Sep 17</span></li> <li><a href="/spring-boot-performance/">Spring Boot Performance</a> <span>Sep 5</span></li> <li><a href="/testing-anti-patterns/">Testing Anti-Patterns</a> <span>Jun 23</span></li> <li><a href="/migrating-to-circleci/">Migrating to CircleCI</a> <span>Apr 26</span></li> </ul> <h4>Tags</h4> <a href="/tags/ci/">ci</a> (3)</a>&nbsp;&nbsp; <a href="/tags/concurrency/">concurrency</a> (4)</a>&nbsp;&nbsp; <a href="/tags/docker/">docker</a> (10)</a>&nbsp;&nbsp; <a href="/tags/gist/">gist</a> (13)</a>&nbsp;&nbsp; <a href="/tags/groovy/">groovy</a> (4)</a>&nbsp;&nbsp; <a href="/tags/java/">java</a> (48)</a>&nbsp;&nbsp; <a href="/tags/jmeter/">jmeter</a> (3)</a>&nbsp;&nbsp; <a href="/tags/junit/">junit</a> (7)</a>&nbsp;&nbsp; <a href="/tags/links/">links</a> (14)</a>&nbsp;&nbsp; <a href="/tags/maven/">maven</a> (18)</a>&nbsp;&nbsp; <a href="/tags/oped/">oped</a> (8)</a>&nbsp;&nbsp; <a href="/tags/performance/">performance</a> (6)</a>&nbsp;&nbsp; <a href="/tags/plaf/">plaf</a> (14)</a>&nbsp;&nbsp; <a href="/tags/ruby/">ruby</a> (3)</a>&nbsp;&nbsp; <a href="/tags/selenium/">selenium</a> (9)</a>&nbsp;&nbsp; <a href="/tags/software/">software</a> (10)</a>&nbsp;&nbsp; <a href="/tags/spring/">spring</a> (7)</a>&nbsp;&nbsp; <a href="/tags/swing/">swing</a> (15)</a>&nbsp;&nbsp; <a href="/tags/testing/">testing</a> (23)</a>&nbsp;&nbsp; <a href="/tags/tips/">tips</a> (4)</a>&nbsp;&nbsp; <a href="/tags/tomcat/">tomcat</a> (3)</a>&nbsp;&nbsp; <a href="/tags/unix/">unix</a> (6)</a>&nbsp;&nbsp; <a href="/tags/web/">web</a> (4)</a>&nbsp;&nbsp; </hr/> <p> <a class="btn btn-primary btn-xs" href="/sitemap">Sitemap</a> <a class="btn btn-primary btn-xs" href="/feed.xml">RSS</a> <a class="btn btn-primary btn-xs" href="//uk.linkedin.com/in/alexecollins">LinkedIn</a> </p> </div> </div> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25388993-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');

</script> </body> </html>